


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Musk & Amber</title>
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="./logo.jpeg">
    <link rel="shortcut icon" type="image/x-icon" href="./logo.jpeg">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #561e4b;
            --primary-dark: #868d7d;
            --danger-color: #f44336;
            --danger-dark: #d32f2f;
            --warning-color: #ff9800;
            --info-color: #7c5772;
            --light-gray: #443b44;
            --medium-gray: #b882aa;
            --dark-gray: #333;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--light-gray);
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        header {
            background-color: rgb(255, 255, 255);
            padding: 15px 20px;
            border-bottom: 1px solid var(--medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .auth-section {
            padding: 40px 20px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .auth-form {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--dark-gray);
            text-align: center;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #444;
            margin-top: 30px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray);
        }
        
        .section {
            background-color: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
        }
        
        input, button, textarea, select { 
            margin: 5px 0; 
            padding: 10px; 
            width: 100%; 
            box-sizing: border-box;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-family: inherit;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: var(--primary-dark);
        }
        
        .delete-btn {
            background-color: var(--danger-color);
        }
        
        .delete-btn:hover {
            background-color: var(--danger-dark);
        }
        
        .secondary-btn {
            background-color: var(--medium-gray);
            color: var(--dark-gray);
        }
        
        .secondary-btn:hover {
            background-color: #d0d0d0;
        }
        
        .upload-btn {
            background-color: var(--info-color);
        }
        
        .upload-btn:hover {
            background-color: #1976D2;
        }
        
        #debug { 
            border: 1px solid #ccc; 
            padding: 10px; 
            max-height: 200px; 
            overflow-y: scroll; 
            background-color: #f9f9f9;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-table th, .data-table td {
            border: 1px solid var(--medium-gray);
            padding: 12px;
            text-align: left;
        }
        
        .data-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .data-table tr:hover {
            background-color: #f1f1f1;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
            background-color: rgb(255, 255, 255);
            flex-wrap: wrap;
        }
        
        .tab-button {
            padding: 12px 24px;
            background-color: #1a0606;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tab-button.active {
            background-color: white;
            border-bottom: 2px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .product-image {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .status-select {
            width: auto;
            padding: 6px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .uploaded-image {
            max-width: 200px;
            max-height: 200px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .upload-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .upload-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .upload-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .upload-progress {
            background-color: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .login-message {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .checkbox-item label {
            margin: 0;
            font-weight: normal;
        }

        /* Message Styles */
        .message-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .message-sender {
            font-weight: bold;
            color: var(--dark-gray);
        }
        
        .message-email {
            color: var(--info-color);
            font-size: 14px;
        }
        
        .message-date {
            color: var(--medium-gray);
            font-size: 12px;
        }
        
        .message-content {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .message-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .message-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-pending {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-read {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Order Details Styles */
        .order-details {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--info-color);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .order-id {
            font-weight: bold;
            color: var(--dark-gray);
        }
        
        .order-total {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .order-items {
            margin: 15px 0;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-name {
            flex: 2;
        }
        
        .item-size {
            flex: 1;
            text-align: center;
        }
        
        .item-price {
            flex: 1;
            text-align: right;
        }
        
        .order-customer {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 300px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .notification-success { 
            background-color: var(--primary-color); 
        }
        
        .notification-error { 
            background-color: var(--danger-color); 
        }
        
        .notification-warning { 
            background-color: var(--warning-color); 
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Search and Filter Styles */
        .search-box {
            margin-bottom: 20px;
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            background: #2c612a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: var(--primary-color);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tab-buttons {
                overflow-x: auto;
            }
            
            .tab-button {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .message-actions, .order-actions {
                flex-direction: column;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 5px;
            }
        }
        .edit-btn {
            background-color: var(--warning-color);
            color: white;
        }

        .edit-btn:hover {
            background-color: #f57c00;
        }
          .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        .radio-item label {
            margin: 0;
            font-weight: normal;
        }
        
        .images-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 4px;
            overflow: hidden;
            border: 2px solid #ddd;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-input-wrapper-multiple {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            margin-top: 10px;
        }
        
        .file-input-wrapper-multiple input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .multi-upload-btn {
            background-color: #7c5772;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }
        
        .multi-upload-btn:hover {
            background-color: #6a4a63;
        }
        
        .volume-radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }
        
        .stock-radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
                /* Enhanced Checkbox Styles */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .checkbox-item:hover {
            background: #f0f0f0;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            flex: 1;
        }
        /* Stock Status Colors */
        .stock-en-stock { background-color: #4caf50; }
        .stock-rupture { background-color: #f44336; }
        .stock-promotion { background-color: #ff9800; }
        .stock-nouveaute { background-color: #9c27b0; }
        /* Add this to your existing CSS */
.order-id-small {
    font-size: 11px !important;
    color: #666 !important;
    font-family: monospace !important;
    background: #f5f5f5 !important;
    padding: 2px 6px !important;
    border-radius: 3px !important;
    margin-right: 5px !important;
}

.whatsapp-link {
    color: #25D366 !important;
    text-decoration: none !important;
    font-weight: bold !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 5px !important;
}

.whatsapp-link:hover {
    text-decoration: underline !important;
}

.download-btn {
    background-color: #34A853 !important;
    color: white !important;
    border: none !important;
    padding: 8px 16px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    font-weight: 500 !important;
    margin-right: 10px !important;
}

.download-btn:hover {
    background-color: #2E8B57 !important;
}

.hide-email {
    display: none !important;
}

.email-toggle-btn {
    background-color: #7c5772 !important;
    color: white !important;
    border: none !important;
    padding: 5px 10px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 12px !important;
    margin-left: 10px !important;
}

.email-toggle-btn:hover {
    background-color: #6a4a63 !important;
}

.export-section {
    background: white !important;
    padding: 15px !important;
    border-radius: 8px !important;
    margin-bottom: 20px !important;
    border-left: 4px solid #34A853 !important;
}

.export-options {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 10px !important;
    margin-top: 10px !important;
}

.google-sheets-status {
    margin-top: 10px !important;
    padding: 10px !important;
    border-radius: 4px !important;
    font-size: 13px !important;
}

.status-success {
    background-color: #d4edda !important;
    color: #155724 !important;
    border: 1px solid #c3e6cb !important;
}

.status-error {
    background-color: #f8d7da !important;
    color: #721c24 !important;
    border: 1px solid #f5c6cb !important;
}
/* These can be removed since we're not using email toggle anymore */
.hide-email {
    display: none !important;
}

.email-toggle-btn {
    background-color: #7c5772 !important;
    color: white !important;
    border: none !important;
    padding: 5px 10px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 12px !important;
    margin-left: 10px !important;
}

.email-toggle-btn:hover {
    background-color: #6a4a63 !important;
}
/* Add to existing CSS */
.product-image-admin {
    border: 2px solid #f0f0f0;
    transition: transform 0.3s;
}

.product-image-admin:hover {
    transform: scale(1.05);
    border-color: var(--primary-color);
}

.no-export-note {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    margin: 5px 0;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div id="authSection" class="auth-section">
            <div class="auth-form">
                <h1>Connexion Admin Musk & Amber</h1>
                <div id="authMessage" class="alert hidden"></div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="admin@musk&amber.com">
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe:</label>
                    <input type="password" id="password" placeholder="Votre mot de passe">
                </div>
                <button onclick="login()">Se connecter</button>
                <div class="login-message">
                    <p>Premi√®re connexion? Utilisez le bouton ci-dessous pour cr√©er un compte.</p>
                    <button class="secondary-btn" onclick="showRegister()">Cr√©er un compte admin</button>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="auth-form hidden">
                <h1>Cr√©er un compte Admin</h1>
                <div class="form-group">
                    <label for="regEmail">Email:</label>
                    <input type="email" id="regEmail" placeholder="admin@musk&amber.com">
                </div>
                <div class="form-group">
                    <label for="regPassword">Mot de passe:</label>
                    <input type="password" id="regPassword" placeholder="Mot de passe s√©curis√©">
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">Confirmer le mot de passe:</label>
                    <input type="password" id="regConfirmPassword" placeholder="Confirmer le mot de passe">
                </div>
                <button onclick="register()">Cr√©er le compte</button>
                <div class="login-message">
                    <button class="secondary-btn" onclick="showLogin()">Retour √† la connexion</button>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <header>
                <div class="logo">Musk & Amber Admin</div>
                <div class="user-info">
                    <span id="userEmail"></span>
                    <button class="secondary-btn" onclick="openTab('profile')">Profil</button>
                    <button class="delete-btn" onclick="logout()">D√©connexion</button>
                </div>
            </header>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab('dashboard')">Tableau de bord</button>
                    <button class="tab-button" onclick="openTab('products')">Produits</button>
                    <button class="tab-button" onclick="openTab('orders')">Commandes</button>
                    <button class="tab-button" onclick="openTab('contactMessages')">Messages Contact</button>
                    <button class="tab-button" onclick="openTab('profile')">Profil</button>
                </div>
                
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <h1>Tableau de bord</h1>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Produits</div>
                            <div class="stat-value" id="productsCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Commandes</div>
                            <div class="stat-value" id="ordersCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Revenus (MAD)</div>
                            <div class="stat-value" id="revenueCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Messages</div>
                            <div class="stat-value" id="messagesCount">0</div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <h2>Derni√®res commandes</h2>
                        <div id="recentOrders"></div>
                    </div>
                    
                    <div class="section">
                        <h2>Derniers messages</h2>
                        <div id="recentMessages"></div>
                    </div>
                </div>
                
                <!-- Products Tab -->
                <div id="products" class="tab-content">
                    <h1>Gestion des produits</h1>
                    
                    <div class="section">
                        <h2>Ajouter un produit</h2>
                         <div class="form-group">
                            <label for="productBrand">Marque:</label>
                            <input type="text" id="productBrand" placeholder="Ex: Channel, Dior, Gucci...">
                        </div>
                        <div class="form-group">
                            <label for="productName">Nom du produit:</label>
                            <input type="text" id="productName" placeholder="Ex: Oud Royal">
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Prix (MAD):</label>
                            <input type="number" id="productPrice" placeholder="600" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Cat√©gories:</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-arabes" value="arabes">
                                    <label for="cat-arabes">Parfums Arabes</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-femme" value="femme">
                                    <label for="cat-femme">Parfums Femme</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-homme" value="homme">
                                    <label for="cat-homme">Parfums Homme</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-niches" value="niches">
                                    <label for="cat-niches">Parfums de niche</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-coffrets" value="coffrets">
                                    <label for="cat-coffrets">Coffrets</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="cat-nouveautes" value="nouveautes">
                                    <label for="cat-nouveautes">Nouveaut√©s</label>
                                </div>
                            </div>
                        </div>
                         <div class="form-group">
                            <label>Volume :</label>
                            <div class="volume-radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="vol-10" name="volume" value="10">
                                    <label for="vol-10">10 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-30" name="volume" value="30">
                                    <label for="vol-30">30 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-50" name="volume" value="50">
                                    <label for="vol-50">50 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-60" name="volume" value="60">
                                    <label for="vol-60">60 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-75" name="volume" value="75">
                                    <label for="vol-75">75 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-80" name="volume" value="80">
                                    <label for="vol-80">80 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-90" name="volume" value="90">
                                    <label for="vol-90">90 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-100" name="volume" value="100">
                                    <label for="vol-100">100 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-150" name="volume" value="150">
                                    <label for="vol-150">150 ml</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="vol-200" name="volume" value="200">
                                    <label for="vol-200">200 ml</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Statut du stock (choix multiples):</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-in" name="stockStatus" value="en stock">
                                    <label for="stock-in">En stock</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-out" name="stockStatus" value="rupture de stock">
                                    <label for="stock-out">Rupture de stock</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-promo" name="stockStatus" value="promotion">
                                    <label for="stock-promo">Promotion</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stock-new" name="stockStatus" value="nouveaut√©">
                                    <label for="stock-new">Nouveaut√©</label>
                                </div>
                              
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="productDescription">Description:</label>
                            <textarea id="productDescription" placeholder="Description du produit..." rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Images du produit:</label>
                            <div class="file-input-wrapper-multiple">
                                <button type="button" class="multi-upload-btn">
                                    <i class="fas fa-images"></i> Choisir plusieurs images (max 5)
                                </button>
                                <input type="file" id="multipleImageInput" accept="image/*" multiple onchange="handleMultipleImagesSelect(event)">
                            </div>
                            <div id="uploadStatus" class="upload-status"></div>
                            
                            <!-- Images preview container -->
                            <div id="imagesPreview" class="images-preview"></div>
                            
                            <!-- Hidden field to store image URLs as JSON -->
                            <input type="hidden" id="productImageUrls">
                        </div>
                        
                        <button onclick="addProduct()">Ajouter Produit</button>
                        <button id="cancelEditBtn" class="secondary-btn hidden" onclick="cancelEdit()" style="margin-left: 10px;">
                            <i class="fas fa-times"></i> Annuler
                        </button>
                    </div>

                    <div class="section">
                        <h2>Produits existants</h2>
                        <div class="search-box">
                            <input type="text" id="productSearch" placeholder="Rechercher un produit..." oninput="searchProducts()">
                        </div>
                        <div id="productsList"></div>
                    </div>
                </div>
                
                <!-- Orders Tab -->
                <!-- Replace the entire Orders Tab content with this: -->
                <div id="orders" class="tab-content">
                    <h1>Gestion des commandes</h1>
    
    <!-- Export Section -->
               <!-- Replace the export-section div with this: -->
               <!-- Update the export section text in your HTML -->
                <div class="export-section">
                    <h3>Export des commandes vers Google Sheets</h3>
                    <p style="color: #666; font-size: 14px;">
                        <i class="fas fa-info-circle" style="color: #34A853;"></i>
                        Export sans images de produits - uniquement les informations textuelles
                    </p>
                    <div class="export-options">
                        <button onclick="exportOrdersToGoogleSheets()" class="download-btn">
                            <i class="fas fa-file-export"></i> Exporter vers CSV (sans images)
                        </button>
                    </div>
                    <div id="googleSheetsStatus" class="googleSheetsStatus" style="display:none;"></div>
                </div>
                
                <div class="filter-options">
                    <button class="filter-btn active" onclick="filterOrders('all')">Toutes</button>
                    <button class="filter-btn" onclick="filterOrders('pending')">En attente</button>
                    <button class="filter-btn" onclick="filterOrders('confirmed')">Confirm√©es</button>
                    <button class="filter-btn" onclick="filterOrders('shipped')">Exp√©di√©es</button>
                    <button class="filter-btn" onclick="filterOrders('delivered')">Livr√©es</button>
                    <button class="filter-btn" onclick="filterOrders('cancelled')">Annul√©es</button>
                </div>
                
                    <div class="section">
                        <div id="ordersList"></div>
                    </div>
                </div>

                <!-- Contact Messages Tab -->
                <div id="contactMessages" class="tab-content">
                    <h1>Messages de Contact</h1>
                    
                    <div class="filter-options">
                        <button class="filter-btn active" onclick="filterMessages('all')">Tous</button>
                        <button class="filter-btn" onclick="filterMessages('new')">Nouveaux</button>
                        <button class="filter-btn" onclick="filterMessages('read')">Lus</button>
                        <button class="filter-btn" onclick="filterMessages('replied')">R√©pondu</button>
                    </div>
                    
                    <!-- Debug Section -->
                    <div class="section" style="margin-top: 20px;">
                        <h3>D√©bogage Messages</h3>
                        <button onclick="debugMessages()" class="secondary-btn">
                            <i class="fas fa-bug"></i> V√©rifier les donn√©es des messages
                        </button>
                        <div id="debugMessages" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px; display: none;"></div>
                    </div>
                    
                    <div class="section">
                        <div id="contactMessagesList"></div>
                    </div>
                </div>
                
                <!-- Profile Tab -->
                <div id="profile" class="tab-content">
                    <h1>Gestion du profil</h1>
                    <div class="section">
                        <h2>Changer le mot de passe</h2>
                        <div class="form-group">
                            <label for="currentPassword">Mot de passe actuel:</label>
                            <input type="password" id="currentPassword">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Nouveau mot de passe:</label>
                            <input type="password" id="newPassword">
                        </div>
                        <div class="form-group">
                            <label for="confirmNewPassword">Confirmer le nouveau mot de passe:</label>
                            <input type="password" id="confirmNewPassword">
                        </div>
                        <button onclick="changePassword()">Changer le mot de passe</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Journal d'activit√©</h2>
                <pre id="debug"></pre>
            </div>
        </div>
    </div>

  <script>
     
   // ========== CONFIGURATION ==========
const firebaseConfig = {
    apiKey: "AIzaSyDxHAlR86M1U_-sBdLtZ6nEh0ssUREQY5M",
    authDomain: "muskandamber-83cd8.firebaseapp.com",
    projectId: "muskandamber-83cd8",
    storageBucket: "muskandamber-83cd8.firebasestorage.app",
    messagingSenderId: "820622006518",
    appId: "1:820622006518:web:540280c4c18f2e94ac74d7",
    measurementId: "G-58WS7ZEYG3"
};

const cloudinaryConfig = {
    cloudName: 'dtjulkl2n',
    uploadPreset: 'MuskandAmber'
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== GLOBAL VARIABLES ==========
let currentImageUrls = []; // Array for multiple images
let allProducts = [];
let allOrders = [];
let allMessages = [];
let isEditMode = false;
let currentEditProductId = null;

// ========== MULTIPLE IMAGE UPLOAD ==========
function handleMultipleImagesSelect(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    // Limit to 5 images
    const selectedFiles = Array.from(files).slice(0, 5);
    
    // Validate files
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
    const invalidFiles = selectedFiles.filter(file => !validTypes.includes(file.type));
    
    if (invalidFiles.length > 0) {
        showUploadStatus('‚ùå Certains fichiers ne sont pas des images valides (JPG, PNG, GIF, WEBP)', 'error');
        return;
    }
    
    // Check file sizes
    const oversizedFiles = selectedFiles.filter(file => file.size > 5 * 1024 * 1024);
    if (oversizedFiles.length > 0) {
        showUploadStatus('‚ùå Certains fichiers d√©passent 5MB', 'error');
        return;
    }
    
    // Display previews
    const previewContainer = document.getElementById('imagesPreview');
    previewContainer.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index + 1}">
                <button type="button" class="remove-image-btn" onclick="removeImagePreview(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            previewContainer.appendChild(previewItem);
        };
        reader.readAsDataURL(file);
    });
    
    // Upload files
    uploadMultipleImages(selectedFiles);
}

async function uploadMultipleImages(files) {
    showUploadStatus(`üì§ Upload de ${files.length} image(s) en cours...`, 'progress');
    
    const uploadedUrls = [];
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        try {
            const url = await uploadSingleImage(file);
            if (url) {
                uploadedUrls.push(url);
                showUploadStatus(`‚úÖ Image ${i + 1}/${files.length} upload√©e`, 'success');
            }
        } catch (error) {
            console.error(`Error uploading image ${i + 1}:`, error);
            showUploadStatus(`‚ùå Erreur lors de l'upload de l'image ${i + 1}`, 'error');
        }
    }
    
    currentImageUrls = uploadedUrls;
    document.getElementById('productImageUrls').value = JSON.stringify(uploadedUrls);
    
    if (uploadedUrls.length > 0) {
        showUploadStatus(`‚úÖ ${uploadedUrls.length} image(s) upload√©e(s) avec succ√®s!`, 'success');
    } else {
        showUploadStatus('‚ùå Aucune image n\'a pu √™tre upload√©e', 'error');
    }
}

async function uploadSingleImage(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('upload_preset', cloudinaryConfig.uploadPreset);
    formData.append('folder', 'muskandamber_products');
    formData.append('tags', 'product,admin');
    
    try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        return data.secure_url;
        
    } catch (error) {
        console.error('Upload error:', error);
        // Provide a fallback placeholder
        const productName = document.getElementById('productName').value || 'Produit';
        return `https://via.placeholder.com/500x500/561e4b/FFFFFF?text=${encodeURIComponent(productName.substring(0, 20))}`;
    }
}

function removeImagePreview(index) {
    const previewContainer = document.getElementById('imagesPreview');
    const previewItems = previewContainer.querySelectorAll('.image-preview-item');
    
    if (previewItems[index]) {
        previewItems[index].remove();
        currentImageUrls.splice(index, 1);
        document.getElementById('productImageUrls').value = JSON.stringify(currentImageUrls);
    }
}

// ========== PRODUCT MANAGEMENT ==========
async function addProduct() {
    if (isEditMode && currentEditProductId) {
        updateProduct(currentEditProductId);
        return;
    }
    
    try {
        const brand = document.getElementById('productBrand').value;
        const name = document.getElementById('productName').value;
        const price = document.getElementById('productPrice').value;
        const description = document.getElementById('productDescription').value;
        
        if (!brand || !name || !price) {
            showNotification('Veuillez remplir la marque, le nom et le prix', 'warning');
            return;
        }

        // Get selected volume
        const volumeRadio = document.querySelector('input[name="volume"]:checked');
        const volume = volumeRadio ? volumeRadio.value : null;
        
        if (!volume) {
            showNotification('Veuillez s√©lectionner un volume', 'warning');
            return;
        }

        // Get selected stock status (multiple choices)
        const stockStatuses = [];
        const stockCheckboxes = document.querySelectorAll('input[name="stockStatus"]:checked');
        stockCheckboxes.forEach(cb => stockStatuses.push(cb.value));

        // If no stock status selected, default to "en stock"
        if (stockStatuses.length === 0) {
            stockStatuses.push('en stock');
        }

        // Get selected categories
        const categories = [];
        const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
        checkboxes.forEach(cb => categories.push(cb.value));
        
        if (categories.length === 0) {
            showNotification('Veuillez s√©lectionner au moins une cat√©gorie', 'warning');
            return;
        }

        // Use uploaded images or fallback
        let imageUrls = currentImageUrls;
        if (imageUrls.length === 0) {
            imageUrls = [`https://via.placeholder.com/500x500/561e4b/FFFFFF?text=${encodeURIComponent(name.substring(0, 20))}`];
        }

        const productData = {
            brand: brand,
            name: name,
            price: parseFloat(price),
            volume: volume,
            stockStatus: stockStatuses, // Keep as array
            stockStatuses: stockStatuses, // Array of all statuses
            category: categories.join(','),
            categories: categories,
            description: description,
            imageUrls: imageUrls,
            mainImage: imageUrls[0],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        console.log('Adding product:', productData);
        await db.collection('products').add(productData);

        showNotification('Produit ajout√© avec succ√®s!', 'success');
        clearProductForm();
        loadProductsFromFirebase();
        loadDashboard();
        
    } catch(err) {
        console.error('Add product error:', err);
        showNotification('Erreur: ' + err.message, 'error');
        addDebugInfo('Erreur ajout produit: ' + err.message);
    }
}

function clearProductForm() {
    document.getElementById('productBrand').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productDescription').value = '';
    document.getElementById('multipleImageInput').value = '';
    
    // Clear image previews
    const previewContainer = document.getElementById('imagesPreview');
    if (previewContainer) previewContainer.innerHTML = '';
    
    // Reset radio buttons
    const volumeRadios = document.querySelectorAll('input[name="volume"]');
    volumeRadios.forEach(radio => radio.checked = false);
    
    // Reset stock status checkboxes
    const stockCheckboxes = document.querySelectorAll('input[name="stockStatus"]');
    stockCheckboxes.forEach(cb => cb.checked = false);
    
    // Set default "en stock" as checked
    const defaultStock = document.getElementById('stock-in');
    if (defaultStock) defaultStock.checked = true;
    
    // Reset categories checkboxes
    document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    // Reset upload status
    document.getElementById('uploadStatus').style.display = 'none';
    
    // Reset global variables
    currentImageUrls = [];
    isEditMode = false;
    currentEditProductId = null;
    
    // Reset button
    const addButton = document.querySelector('#products button[onclick="addProduct()"]');
    if (addButton) {
        addButton.textContent = 'Ajouter Produit';
        addButton.style.backgroundColor = '';
    }
    
    // Hide cancel button
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) cancelBtn.classList.add('hidden');
}

async function loadProductsFromFirebase() {
    try {
        const snapshot = await db.collection('products').orderBy('createdAt', 'desc').get();
        allProducts = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            allProducts.push({
                id: doc.id,
                ...data,
                createdAt: data.createdAt ? data.createdAt.toDate() : new Date()
            });
        });
        
        displayProducts(allProducts);
        addDebugInfo(`Charg√© ${allProducts.length} produits`);
    } catch(err) {
        const productsList = document.getElementById('productsList');
        if (productsList) {
            productsList.innerHTML = '<p style="color: red;">Erreur de chargement: ' + err.message + '</p>';
        }
        showNotification('Erreur de chargement des produits: ' + err.message, 'error');
        addDebugInfo('Erreur produits: ' + err.message);
        console.error('Load products error:', err);
    }
}

function displayProducts(products) {
    const list = document.getElementById('productsList');
    if (!list) return;
    
    if (products.length === 0) {
        list.innerHTML = '<p>Aucun produit trouv√©.</p>';
        return;
    }
    
    let html = '<div class="products-grid">';
    
    products.forEach(p => {
        const categories = p.categories || (p.category ? p.category.split(',') : []);
        const categoryBadges = categories.map(cat => 
            `<span style="background:#f0f0f0;padding:2px 8px;border-radius:12px;font-size:12px;margin-right:5px;">${cat}</span>`
        ).join('');
        
        // Stock status badges (multiple)
        const stockColors = {
            'en stock': '#4caf50',
            'rupture de stock': '#f44336',
            'promotion': '#ff9800',
            'nouveaut√©': '#9c27b0',
            'best-seller': '#2196f3',
            '√©dition limit√©e': '#ff5722'
        };

        // Get stock statuses as array
        const stockStatuses = Array.isArray(p.stockStatus) 
            ? p.stockStatus 
            : (p.stockStatuses ? p.stockStatuses : ['en stock']);
            
        // Create badges for each stock status
        const stockBadges = stockStatuses.map(status => {
            const color = stockColors[status] || '#9e9e9e';
            return `<span style="background:${color};color:white;padding:2px 8px;border-radius:12px;font-size:12px;margin:2px;display:inline-block;">
                ${status}
            </span>`;
        }).join('');
        
        // Get first image for display
        const displayImage = p.mainImage || p.imageUrl || 
            (p.imageUrls && p.imageUrls.length > 0 ? p.imageUrls[0] : 
            'https://via.placeholder.com/100?text=No+Image');
        
        html += `
            <div class="product-item" style="border:1px solid #eee;border-radius:8px;padding:15px;margin-bottom:15px;">
                <div style="display:flex;gap:15px;">
                    <img src="${displayImage}" 
                         style="width:100px;height:100px;object-fit:cover;border-radius:4px;"
                         onerror="this.src='https://via.placeholder.com/100?text=Image+Error'">
                    <div style="flex:1;">
                        <div style="display:flex;justify-content:space-between;">
                            <div>
                                <h3 style="margin:0;">${p.name || 'Sans nom'}</h3>
                                <div style="color:#666;font-size:14px;margin-top:2px;">
                                    <strong>Marque:</strong> ${p.brand || 'Non sp√©cifi√©'}
                                </div>
                            </div>
                            <div>
                                <div style="font-weight:bold;color:#561e4b;font-size:18px;">${p.price || 0} MAD</div>
                                <div style="font-size:14px;color:#666;">${p.volume || ''} ml</div>
                            </div>
                        </div>
                        <div style="margin:10px 0;">
                            ${categoryBadges}
                            <div style="margin-top:5px;">
                                ${stockBadges}
                            </div>
                        </div>
                        <p style="color:#666;margin:5px 0;font-size:14px;">
                            ${(p.description || 'Pas de description').substring(0, 100)}${p.description && p.description.length > 100 ? '...' : ''}
                        </p>
                        <div style="margin-top:10px;">
                            <button class="delete-btn" onclick="deleteProduct('${p.id}')" style="padding:5px 10px;font-size:12px;">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                            <button onclick="editProduct('${p.id}')" class="edit-btn" style="padding:5px 10px;font-size:12px;margin-left:5px;">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            ${p.imageUrls && p.imageUrls.length > 1 ? 
                                `<span style="margin-left:10px;font-size:12px;color:#666;">
                                    <i class="fas fa-images"></i> ${p.imageUrls.length} images
                                </span>` : ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    list.innerHTML = html;
}

function editProduct(productId) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) {
        showNotification('Produit non trouv√©', 'error');
        return;
    }
    
    // Set edit mode
    isEditMode = true;
    currentEditProductId = productId;
    
    // Scroll to the top form
    openTab('products');
    
    // Fill the form with product data
    document.getElementById('productBrand').value = product.brand || '';
    document.getElementById('productName').value = product.name || '';
    document.getElementById('productPrice').value = product.price || '';
    document.getElementById('productDescription').value = product.description || '';
    
    // Set volume radio
    const volumeRadios = document.querySelectorAll('input[name="volume"]');
    volumeRadios.forEach(radio => {
        radio.checked = (radio.value === product.volume);
    });
    
    // Set stock status checkboxes (multiple choices)
    const stockCheckboxes = document.querySelectorAll('input[name="stockStatus"]');
    const productStockStatuses = Array.isArray(product.stockStatus) 
        ? product.stockStatus 
        : (product.stockStatuses ? product.stockStatuses : ['en stock']);
    
    stockCheckboxes.forEach(checkbox => {
        checkbox.checked = productStockStatuses.includes(checkbox.value);
    });
    
    // Set categories checkboxes
    const categories = product.categories || (product.category ? product.category.split(',') : []);
    document.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = categories.includes(checkbox.value);
    });
    
    // Display existing images
    const previewContainer = document.getElementById('imagesPreview');
    previewContainer.innerHTML = '';
    currentImageUrls = product.imageUrls || (product.imageUrl ? [product.imageUrl] : []);
    
    currentImageUrls.forEach((url, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'image-preview-item';
        previewItem.innerHTML = `
            <img src="${url}" alt="Image ${index + 1}">
            <button type="button" class="remove-image-btn" onclick="removeImagePreview(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        previewContainer.appendChild(previewItem);
    });
    
    // Update hidden field
    document.getElementById('productImageUrls').value = JSON.stringify(currentImageUrls);
    
    // Change the button
    const addButton = document.querySelector('#products button[onclick="addProduct()"]');
    if (addButton) {
        addButton.textContent = 'Modifier Produit';
        addButton.style.backgroundColor = '#ff9800';
    }
    
    // Show cancel button
    const cancelBtn = document.getElementById('cancelEditBtn');
    if (cancelBtn) cancelBtn.classList.remove('hidden');
    
    showNotification('Modifiez le produit ci-dessous', 'info');
}

async function updateProduct(productId) {
    try {
        const brand = document.getElementById('productBrand').value;
        const name = document.getElementById('productName').value;
        const price = document.getElementById('productPrice').value;
        const description = document.getElementById('productDescription').value;
        
        if (!brand || !name || !price) {
            showNotification('Veuillez remplir la marque, le nom et le prix', 'warning');
            return;
        }

        // Get selected volume
        const volumeRadio = document.querySelector('input[name="volume"]:checked');
        const volume = volumeRadio ? volumeRadio.value : null;
        
        if (!volume) {
            showNotification('Veuillez s√©lectionner un volume', 'warning');
            return;
        }

        // Get selected stock status (multiple choices)
        const stockStatuses = [];
        const stockCheckboxes = document.querySelectorAll('input[name="stockStatus"]:checked');
        stockCheckboxes.forEach(cb => stockStatuses.push(cb.value));
        
        // If no stock status selected, default to "en stock"
        if (stockStatuses.length === 0) {
            stockStatuses.push('en stock');
        }

        // Get selected categories
        const categories = [];
        const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
        checkboxes.forEach(cb => categories.push(cb.value));
        
        if (categories.length === 0) {
            showNotification('Veuillez s√©lectionner au moins une cat√©gorie', 'warning');
            return;
        }

        // Use uploaded images or existing ones
        let imageUrls = currentImageUrls;
        if (imageUrls.length === 0) {
            // Keep existing images if no new ones uploaded
            const existingProduct = allProducts.find(p => p.id === productId);
            imageUrls = existingProduct.imageUrls || (existingProduct.imageUrl ? [existingProduct.imageUrl] : []);
        }

        const productData = {
            brand: brand,
            name: name,
            price: parseFloat(price),
            volume: volume,
            stockStatus: stockStatuses, // Keep as array
            stockStatuses: stockStatuses, // Array of all statuses
            category: categories.join(','),
            categories: categories,
            description: description,
            imageUrls: imageUrls,
            mainImage: imageUrls[0],
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        console.log('Updating product:', productId, productData);
        await db.collection('products').doc(productId).update(productData);

        showNotification('Produit modifi√© avec succ√®s!', 'success');
        clearProductForm();
        loadProductsFromFirebase();
        loadDashboard();
        
    } catch(err) {
        console.error('Update product error:', err);
        showNotification('Erreur: ' + err.message, 'error');
        addDebugInfo('Erreur modification produit: ' + err.message);
    }
}

async function deleteProduct(id) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce produit?')) return;
    
    try {
        await db.collection('products').doc(id).delete();
        showNotification('Produit supprim√©!', 'success');
        loadProductsFromFirebase();
        loadDashboard();
    } catch(err) {
        showNotification('Erreur: ' + err.message, 'error');
    }
}

// ========== ORDERS MANAGEMENT ==========
async function loadOrders() {
    try {
        // Try multiple possible field names for ordering
        let snapshot;
        try {
            snapshot = await db.collection('orders').orderBy('timestamp', 'desc').get();
        } catch (e) {
            try {
                snapshot = await db.collection('orders').orderBy('createdAt', 'desc').get();
            } catch (e2) {
                // If both fail, just get without ordering
                snapshot = await db.collection('orders').get();
            }
        }
        
        allOrders = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            console.log('Raw order data:', doc.id, JSON.parse(JSON.stringify(data)));
            
            // Get customer object from data
            const customer = data.customer || {};
            console.log('Customer object:', JSON.parse(JSON.stringify(customer)));
            
            // Enhanced data normalization - FIXED FOR NESTED CUSTOMER OBJECT
            const orderData = {
                id: doc.id,
                ...data,
                // Normalize timestamp/createdAt
                createdAt: data.createdAt ? data.createdAt.toDate() : 
                          data.timestamp ? data.timestamp.toDate() : 
                          data.date ? data.date.toDate() : new Date(),
                // Normalize total amount
                totalAmount: data.totalAmount || data.total || data.amount || data.prixTotal || 0,
                // Normalize status
                status: data.status || data.orderStatus || data.statut || 'pending',
                // Normalize items
                items: data.items || data.products || data.orderItems || data.article || [],
                
                // FIXED: Extract customer info from nested customer object
                fullName: customer.fullName || customer.name || customer.customerName || 
                         customer.nom || customer.nomComplet || 
                         (customer.firstName && customer.lastName ? `${customer.firstName} ${customer.lastName}` : '') ||
                         customer.firstName || customer.lastName || data.fullName || data.name || 'Client',
                
                email: customer.email || customer.customerEmail || customer.courriel || 
                      data.email || data.customerEmail || '',
                
                // FIXED: Phone number fields from customer object
                phone: customer.phone || customer.customerPhone || customer.telephone || 
                      customer.numeroTelephone || customer.numTel || 
                      data.phone || data.customerPhone || '',
                
                // FIXED: Address fields from customer object
                address: customer.address || customer.shippingAddress || customer.deliveryAddress || 
                        customer.adresse || customer.adresseLivraison ||
                        data.address || data.shippingAddress || '',
                
                city: customer.city || customer.shippingCity || customer.ville || 
                     data.city || data.shippingCity || '',
                
                postalCode: customer.postalCode || customer.zipCode || customer.codePostal || 
                          customer.postal || customer.zip ||
                          data.postalCode || data.zipCode || ''
            };
            
            // DEBUG: Log what was actually extracted
            console.log('Extracted customer info:', {
                fullName: orderData.fullName,
                email: orderData.email,
                phone: orderData.phone,
                address: orderData.address,
                city: orderData.city,
                postalCode: orderData.postalCode
            });
            
            allOrders.push(orderData);
        });
        
        displayOrders(allOrders);
        updateOrderStats();
        addDebugInfo(`Charg√© ${allOrders.length} commandes`);
    
    } catch(err) {
        console.error('Orders load error:', err);
        const ordersList = document.getElementById('ordersList');
        if (ordersList) {
            ordersList.innerHTML = `
                <div style="color: red; padding: 20px; text-align: center;">
                    <h4>Erreur de chargement des commandes</h4>
                    <p>${err.message}</p>
                    <button onclick="loadOrders()" class="secondary-btn">R√©essayer</button>
                    <button onclick="diagnoseOrders()" class="secondary-btn">Diagnostiquer</button>
                </div>
            `;
        }
        showNotification('Erreur de chargement des commandes: ' + err.message, 'error');
        addDebugInfo('Erreur commandes: ' + err.message);
    }
}

function displayOrders(orders) {
    const list = document.getElementById('ordersList');
    if (!list) {
        console.error('ordersList element not found!');
        return;
    }
    
    if (orders.length === 0) {
        list.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-shopping-cart" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                <p style="color: #666;">Aucune commande trouv√©e.</p>
                <button onclick="loadOrders()" class="secondary-btn">Rafra√Æchir</button>
            </div>
        `;
        return;
    }
    
    let html = '<div class="orders-list">';
    
    // Display total orders count with small IDs
    html += `
        <div style="background: #f8f9fa; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-weight: bold; color: #561e4b;">
                    <i class="fas fa-shopping-cart"></i> ${orders.length} commande(s)
                </span>
                <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 5px;">
                    ${orders.slice(0, 10).map(order => 
                        `<span class="order-id-small">#${order.id.substring(0, 8).toUpperCase()}</span>`
                    ).join('')}
                    ${orders.length > 10 ? `<span style="color:#666;font-size:11px;">+${orders.length - 10} autres</span>` : ''}
                </div>
            </div>
        </div>
    `;
    
    orders.forEach(order => {
        // Items display (without images)
        let itemsHtml = '';
        if (order.items && order.items.length > 0) {
            order.items.forEach(item => {
                if (typeof item === 'object') {
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #f0f0f0;">
                            <div>
                                <strong>${item.name || item.productName || item.title || item.nom || 'Produit'}</strong>
                                ${item.size ? ` (${item.size})` : ''}
                                ${item.quantity ? ` √ó ${item.quantity}` : ''}
                            </div>
                            <div>${item.price || item.prix || 0} MAD</div>
                        </div>
                    `;
                } else {
                    itemsHtml += `<div>${item}</div>`;
                }
            });
        } else {
            itemsHtml = '<p style="color: #999; font-style: italic;">Aucun d√©tail d\'article</p>';
        }
        
        // Status colors
        const statusColors = {
            'pending': '#ff9800',
            'confirmed': '#2196f3',
            'shipped': '#9c27b0',
            'delivered': '#4caf50',
            'cancelled': '#f44336'
        };
        
        const statusText = getStatusText(order.status);
        const statusColor = statusColors[order.status] || '#9e9e9e';
        
        // Customer info
        const customerName = order.fullName || 'Client';
        const customerPhone = order.phone || '';
        const customerEmail = order.email || '';
        
        // WhatsApp link
        let whatsappLink = '';
        if (customerPhone) {
            const cleanPhone = customerPhone.replace(/\D/g, '');
            // Check if phone starts with country code
            const phoneWithCountryCode = cleanPhone.startsWith('212') ? cleanPhone : 
                                       (cleanPhone.startsWith('0') ? '212' + cleanPhone.substring(1) : 
                                       '212' + cleanPhone);
            whatsappLink = `https://wa.me/${phoneWithCountryCode}`;
        }
        
        // Address display
        let addressDisplay = '';
        if (order.address) {
            addressDisplay = order.address;
            if (order.city) addressDisplay += `<br>${order.city}`;
            if (order.postalCode) addressDisplay += ` ${order.postalCode}`;
        } else {
            addressDisplay = '<span style="color:#999">Non sp√©cifi√©</span>';
        }
        
        html += `
            <div class="order-card" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: white;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                    <div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <h3 style="margin: 0; font-size: 16px; display: flex; align-items: center; gap: 5px;">
                                Commande 
                                <span class="order-id-small" style="font-size: 12px !important;">
                                    #${order.id.substring(0, 8).toUpperCase()}
                                </span>
                            </h3>
                            <span style="background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                ${statusText}
                            </span>
                        </div>
                        <div style="font-size: 14px; color: #666; margin-top: 5px;">
                            <i class="far fa-calendar"></i> ${formatDate(order.createdAt)}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 24px; font-weight: bold; color: #561e4b;">${parseFloat(order.totalAmount).toFixed(2)} MAD</div>
                        <div style="font-size: 12px; color: #666;">Total</div>
                    </div>
                </div>
                
                <div style="background: #f9f9f9; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">Articles command√©s</h4>
                    <div>
                        ${itemsHtml}
                    </div>
                </div>
                
                <div style="background: #f5f5f5; border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">Informations client</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>Nom:</strong><br>
                            ${customerName}
                        </div>
                        <div>
                            <strong>T√©l√©phone:</strong><br>
                            ${customerPhone ? 
                                `<a href="${whatsappLink}" target="_blank" class="whatsapp-link">
                                    <i class="fab fa-whatsapp"></i> ${customerPhone}
                                </a>` : 
                                '<span style="color:#999">Non sp√©cifi√©</span>'
                            }
                        </div>
                        <div>
                            <strong>Adresse:</strong><br>
                            ${addressDisplay}
                        </div>
                    </div>
                    <!-- Email shown in a subtle way -->
                    <div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #7c5772;">
                        <div style="font-size: 13px; color: #666;">
                            <i class="fas fa-envelope"></i> 
                            <strong>Email:</strong> ${customerEmail || 'Non fourni par le client'}
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee;">
                    <div style="display: flex; gap: 10px;">
                        <select onchange="updateOrderStatus('${order.id}', this.value)" 
                                style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>En attente</option>
                            <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirm√©e</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Exp√©di√©e</option>
                            <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Livr√©e</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annul√©e</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="viewOrderDetails('${order.id}')" 
                                class="secondary-btn" 
                                style="padding: 8px 16px;">
                            <i class="fas fa-eye"></i> D√©tails
                        </button>
                        <button onclick="deleteOrder('${order.id}')" 
                                class="delete-btn" 
                                style="padding: 8px 16px;">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    list.innerHTML = html;
}

async function diagnoseOrders() {
    try {
        console.log('=== ORDERS DIAGNOSIS ===');
        const snapshot = await db.collection('orders').limit(1).get();
        
        if (!snapshot.empty) {
            const firstDoc = snapshot.docs[0];
            const data = firstDoc.data();
            
            console.log('First order full data:', JSON.parse(JSON.stringify(data)));
            console.log('Customer object type:', typeof data.customer);
            console.log('Customer object:', data.customer);
            
            if (data.customer) {
                console.log('Customer object keys:', Object.keys(data.customer));
                console.log('Customer email field exists:', 'email' in data.customer);
                console.log('All customer fields:');
                for (const key in data.customer) {
                    console.log(`  ${key}:`, data.customer[key]);
                }
            }
        }
        
        console.log('=== END DIAGNOSIS ===');
        
    } catch(err) {
        console.error('Diagnosis error:', err);
    }
}

function filterOrders(status) {
    // Update active filter button
    document.querySelectorAll('.filter-options .filter-btn').forEach(btn => btn.classList.remove('active'));
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    if (status === 'all') {
        displayOrders(allOrders);
    } else {
        const filtered = allOrders.filter(order => order.status === status);
        displayOrders(filtered);
    }
}

async function updateOrderStatus(orderId, newStatus) {
    try {
        await db.collection('orders').doc(orderId).update({
            status: newStatus,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Statut mis √† jour!', 'success');
        loadOrders();
        loadDashboard();
    } catch(err) {
        showNotification('Erreur: ' + err.message, 'error');
    }
}

async function deleteOrder(orderId) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette commande?\nCette action est irr√©versible.')) {
        return;
    }
    
    try {
        await db.collection('orders').doc(orderId).delete();
        showNotification('Commande supprim√©e avec succ√®s!', 'success');
        loadOrders();
        loadDashboard();
    } catch(err) {
        showNotification('Erreur lors de la suppression: ' + err.message, 'error');
    }
}

// ========== GOOGLE SHEETS EXPORT (WITHOUT IMAGES) ==========
async function exportOrdersToGoogleSheets() {
    try {
        showNotification('Pr√©paration de l\'export vers Google Sheets...', 'info');
        
        // Filter orders without cancelled ones
        const activeOrders = allOrders.filter(order => order.status !== 'cancelled');
        
        if (activeOrders.length === 0) {
            showNotification('Aucune commande √† exporter', 'warning');
            return;
        }
        
        // Prepare data for CSV - NO IMAGE COLUMNS
        const headers = [
            'ID Commande',
            'Date',
            'Statut',
            'Nom Client',
            'T√©l√©phone',
            'WhatsApp',
            'Total (MAD)',
            'Articles',
            'Quantit√©',
            'Prix Unitaire',
            'Sous-total'
        ];
        
        const rows = activeOrders.map(order => {
            // Prepare items text WITHOUT IMAGES
            let itemsText = '';
            let quantity = 0;
            let unitPrice = 0;
            let subtotal = 0;
            
            if (order.items && order.items.length > 0) {
                itemsText = order.items.map(item => {
                    if (typeof item === 'object') {
                        const itemName = item.name || item.productName || 'Produit';
                        const itemQuantity = item.quantity || 1;
                        const itemPrice = item.price || item.prix || 0;
                        const itemSize = item.size ? ` (${item.size})` : '';
                        
                        quantity = itemQuantity;
                        unitPrice = parseFloat(itemPrice);
                        subtotal = itemQuantity * unitPrice;
                        
                        return `${itemName}${itemSize}`;
                    }
                    return item;
                }).join('; ');
            }
            
            // Format WhatsApp link
            const phone = order.phone || '';
            const whatsappLink = phone ? `https://wa.me/${phone.replace(/\D/g, '')}` : '';
            
            return [
                order.id.substring(0, 8).toUpperCase(),
                formatDate(order.createdAt),
                getStatusText(order.status),
                order.fullName || 'Client',
                phone,
                whatsappLink,
                parseFloat(order.totalAmount || 0).toFixed(2),
                itemsText, // Product names only, no images
                quantity || 1,
                unitPrice.toFixed(2),
                subtotal.toFixed(2)
            ];
        });
        
        // Create CSV content
        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');
        
        // Create and download CSV file
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `commandes_musk_amber_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification(`${activeOrders.length} commandes export√©es sans images!`, 'success');
        
        // Show instructions
        showGoogleSheetsInstructions();
        
    } catch(err) {
        console.error('Export error:', err);
        showNotification('Erreur lors de l\'export: ' + err.message, 'error');
    }
}

function showGoogleSheetsInstructions() {
    const instructions = `
<strong>‚úì Fichier CSV export√© sans images!</strong><br><br>
<strong>Pour Google Sheets:</strong>
1. Ouvrez Google Sheets
2. Menu: Fichier ‚Üí Importer
3. Choisir "Charger" et s√©lectionnez le fichier CSV
4. Cliquez sur "Importer les donn√©es"

<strong>Contenu export√©:</strong>
‚úì Informations commandes
‚úì Statuts
‚úì Contacts clients
‚úì Articles (noms uniquement)
‚úì Totaux
<strong style="color: #34A853;">‚úó Aucune image de produit</strong>
    `;
    
    const statusDiv = document.getElementById('googleSheetsStatus');
    if (statusDiv) {
        statusDiv.innerHTML = `
            <div class="status-success">
                ${instructions}
                <button onclick="copyToClipboard()" class="secondary-btn" style="margin-top:10px;">
                    <i class="fas fa-copy"></i> Copier les donn√©es
                </button>
            </div>
        `;
        statusDiv.style.display = 'block';
    }
}

async function copyToClipboard() {
    try {
        const activeOrders = allOrders.filter(order => order.status !== 'cancelled');
        const headers = [
            'ID Commande',
            'Date',
            'Statut',
            'Nom Client',
            'T√©l√©phone',
            'WhatsApp',
            'Total (MAD)',
            'Articles'
        ];
        
        const rows = activeOrders.map(order => {
            let itemsText = '';
            if (order.items && order.items.length > 0) {
                itemsText = order.items.map(item => {
                    if (typeof item === 'object') {
                        return `${item.name || item.productName || 'Produit'} x${item.quantity || 1}`;
                    }
                    return item;
                }).join('; ');
            }
            
            const phone = order.phone || '';
            const whatsappLink = phone ? `https://wa.me/${phone.replace(/\D/g, '')}` : '';
            
            return [
                order.id.substring(0, 8).toUpperCase(),
                formatDate(order.createdAt),
                getStatusText(order.status),
                order.fullName || 'Client',
                phone,
                whatsappLink,
                parseFloat(order.totalAmount || 0).toFixed(2),
                itemsText // NO IMAGES HERE
            ].join('\t');
        });
        
        const textToCopy = [headers.join('\t'), ...rows].join('\n');
        
        await navigator.clipboard.writeText(textToCopy);
        showNotification('Donn√©es (sans images) copi√©es!', 'success');
    } catch(err) {
        showNotification('Erreur de copie: ' + err.message, 'error');
    }
}

// ========== CONTACT MESSAGES ==========
async function loadContactMessages() {
    try {
        const snapshot = await db.collection('contactMessages').orderBy('timestamp', 'desc').get();
        allMessages = [];
        
        snapshot.forEach(doc => {
            const data = doc.data();
            allMessages.push({
                id: doc.id,
                ...data,
                timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
            });
        });
        
        displayContactMessages(allMessages);
        updateMessageStats();
        addDebugInfo(`Charg√© ${allMessages.length} messages`);
        
    } catch(err) {
        const contactMessagesList = document.getElementById('contactMessagesList');
        if (contactMessagesList) {
            contactMessagesList.innerHTML = 
                '<p style="color: red;">Erreur de chargement: ' + err.message + '</p>';
        }
        addDebugInfo('Erreur chargement messages: ' + err.message);
        showNotification('Erreur de chargement des messages: ' + err.message, 'error');
        console.error('Load messages error:', err);
    }
}

function displayContactMessages(messages) {
    const list = document.getElementById('contactMessagesList');
    if (!list) return;
    
    if (messages.length === 0) {
        list.innerHTML = '<p>Aucun message trouv√©.</p>';
        return;
    }
    
    let html = '<div class="messages-list">';
    
    messages.forEach(msg => {
        const statusClass = msg.status === 'read' ? 'status-read' : 'status-pending';
        const statusText = msg.status === 'read' ? 'Lu' : 'Nouveau';
        const repliedBadge = msg.replied ? '<span style="background:#4CAF50;color:white;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:5px;">R√©pondu</span>' : '';
        
        html += `
            <div class="message-container" id="message-${msg.id}">
                <div class="message-header">
                    <div>
                        <div class="message-sender">${msg.name || 'Anonyme'}</div>
                        <div class="message-email">${msg.email || 'Pas d\'email'}</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="message-date">${formatDate(msg.timestamp)}</div>
                        <div style="margin-top:5px;">
                            <span class="message-status ${statusClass}">${statusText}</span>
                            ${repliedBadge}
                        </div>
                    </div>
                </div>
                
                <div class="message-content">
                    <p><strong>Sujet:</strong> ${msg.subject || 'Pas de sujet'}</p>
                    <p>${msg.message || 'Pas de contenu'}</p>
                </div>
                
                <div class="message-actions">
                    <button onclick="markAsRead('${msg.id}')" class="secondary-btn" style="padding:8px 15px;">
                        <i class="fas fa-check"></i> Marquer comme lu
                    </button>
                    <button onclick="markAsReplied('${msg.id}')" class="secondary-btn" style="padding:8px 15px;">
                        <i class="fas fa-reply"></i> Marquer comme r√©pondu
                    </button>
                    <button onclick="replyToMessage('${msg.id}', '${msg.email}')" class="secondary-btn" style="padding:8px 15px;">
                        <i class="fas fa-envelope"></i> R√©pondre
                    </button>
                    <button onclick="deleteMessage('${msg.id}')" class="delete-btn" style="padding:8px 15px;">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    list.innerHTML = html;
}

function filterMessages(filter) {
    // Update active filter button
    const filterButtons = document.querySelectorAll('#contactMessages .filter-options .filter-btn');
    if (filterButtons.length > 0) {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        if (event && event.target) {
            event.target.classList.add('active');
        }
    }
    
    let filtered;
    
    switch(filter) {
        case 'new':
            filtered = allMessages.filter(msg => msg.status !== 'read');
            break;
        case 'read':
            filtered = allMessages.filter(msg => msg.status === 'read');
            break;
        case 'replied':
            filtered = allMessages.filter(msg => msg.replied === true);
            break;
        default: // 'all'
            filtered = allMessages;
    }
    
    displayContactMessages(filtered);
}

async function markAsRead(messageId) {
    try {
        await db.collection('contactMessages').doc(messageId).update({
            status: 'read',
            readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Message marqu√© comme lu', 'success');
        loadContactMessages();
        loadDashboard();
    } catch(err) {
        showNotification('Erreur: ' + err.message, 'error');
    }
}

async function markAsReplied(messageId) {
    try {
        await db.collection('contactMessages').doc(messageId).update({
            replied: true,
            repliedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Message marqu√© comme r√©pondu', 'success');
        loadContactMessages();
    } catch(err) {
        showNotification('Erreur: ' + err.message, 'error');
    }
}

function replyToMessage(messageId, email) {
    const subject = prompt('Sujet de la r√©ponse:');
    if (!subject) return;
    
    const message = prompt('Message de r√©ponse:');
    if (!message) return;
    
    // Here you would typically send an email
    // For now, just mark as replied
    markAsReplied(messageId);
    
    // Simulate sending email
    showNotification(`R√©ponse envoy√©e √† ${email}`, 'success');
    addDebugInfo(`R√©ponse envoy√©e √† ${email}: ${subject}`);
}

async function deleteMessage(messageId) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce message?')) return;
    
    try {
        await db.collection('contactMessages').doc(messageId).delete();
        showNotification('Message supprim√©!', 'success');
        loadContactMessages();
        loadDashboard();
    } catch(err) {
        showNotification('Erreur: ' + err.message, 'error');
    }
}

// ========== DASHBOARD FUNCTIONS ==========
async function loadDashboard() {
    try {
        addDebugInfo('Chargement du dashboard...');
        
        // Load products count
        const productsSnapshot = await db.collection('products').get();
        const productsCountEl = document.getElementById('productsCount');
        if (productsCountEl) {
            productsCountEl.textContent = productsSnapshot.size;
            addDebugInfo(`Produits: ${productsSnapshot.size}`);
        }
        
        // Load orders count
        const ordersSnapshot = await db.collection('orders').get();
        const ordersCountEl = document.getElementById('ordersCount');
        if (ordersCountEl) {
            ordersCountEl.textContent = ordersSnapshot.size;
            addDebugInfo(`Commandes: ${ordersSnapshot.size}`);
        }
        
        // Calculate revenue - FIXED VERSION
        let revenue = 0;
        ordersSnapshot.forEach(doc => {
            const order = doc.data();
            // Get total from any possible field name
            const orderTotal = order.totalAmount || order.total || order.amount || 0;
            // Only count non-cancelled orders
            if (order.status !== 'cancelled') {
                revenue += parseFloat(orderTotal);
            }
        });
        
        const revenueCountEl = document.getElementById('revenueCount');
        if (revenueCountEl) {
            revenueCountEl.textContent = revenue.toFixed(2) + ' MAD';
            addDebugInfo(`Revenus: ${revenue.toFixed(2)} MAD calcul√©s sur ${ordersSnapshot.size} commandes`);
        }
        
        // Load messages count
        const messagesSnapshot = await db.collection('contactMessages').get();
        const messagesCountEl = document.getElementById('messagesCount');
        if (messagesCountEl) {
            messagesCountEl.textContent = messagesSnapshot.size;
            addDebugInfo(`Messages: ${messagesSnapshot.size}`);
        }
        
        // Load recent orders
        await loadRecentOrders();
        
        // Load recent messages
        await loadRecentMessages();
        
        addDebugInfo('Dashboard charg√© avec succ√®s');
        
    } catch(err) {
        console.error('Dashboard error:', err);
        showNotification('Erreur de chargement du tableau de bord: ' + err.message, 'error');
        addDebugInfo('Erreur dashboard: ' + err.message);
    }
}

async function loadRecentOrders() {
    try {
        let snapshot;
        try {
            snapshot = await db.collection('orders')
                .orderBy('timestamp', 'desc')
                .limit(5)
                .get();
        } catch (e) {
            try {
                snapshot = await db.collection('orders')
                    .orderBy('createdAt', 'desc')
                    .limit(5)
                    .get();
            } catch (e2) {
                snapshot = await db.collection('orders').limit(5).get();
            }
        }
        
        let html = '';
        if (!snapshot || snapshot.empty) {
            html = '<div style="padding: 20px; text-align: center; color: #666;">Aucune commande r√©cente</div>';
        } else {
            snapshot.forEach(doc => {
                const order = doc.data();
                const orderTotal = order.totalAmount || order.total || order.amount || 0;
                const customerName = order.fullName || order.name || order.customerName || order.firstName + ' ' + order.lastName || 'Client';
                
                html += `
                    <div style="padding: 12px; border-bottom: 1px solid #eee; transition: background 0.3s;" 
                         onmouseover="this.style.background='#f9f9f9'" 
                         onmouseout="this.style.background='white'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${customerName}</div>
                                <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                    <i class="far fa-calendar-alt"></i> ${formatDate(order.createdAt || order.timestamp || order.date)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #561e4b;">${parseFloat(orderTotal).toFixed(2)} MAD</div>
                                <div style="font-size: 11px; color: ${getStatusColor(order.status || order.orderStatus)};">
                                    ${getStatusText(order.status || order.orderStatus)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        const recentOrdersEl = document.getElementById('recentOrders');
        if (recentOrdersEl) {
            recentOrdersEl.innerHTML = html;
        }
    } catch(err) {
        const recentOrdersEl = document.getElementById('recentOrders');
        if (recentOrdersEl) {
            recentOrdersEl.innerHTML = '<div style="color:#f44336; padding: 10px;">Erreur de chargement</div>';
        }
        console.error('Recent orders error:', err);
    }
}

async function loadRecentMessages() {
    try {
        const snapshot = await db.collection('contactMessages')
            .orderBy('timestamp', 'desc')
            .limit(5)
            .get();
        
        let html = '';
        snapshot.forEach(doc => {
            const msg = doc.data();
            const statusClass = msg.status === 'read' ? 'status-read' : 'status-pending';
            
            html += `
                <div style="padding:10px;border-bottom:1px solid #eee;">
                    <div style="display:flex;justify-content:space-between;">
                        <span><strong>${msg.name || 'Anonyme'}</strong></span>
                        <span class="message-status ${statusClass}" style="font-size:10px;">
                            ${msg.status === 'read' ? 'Lu' : 'Nouveau'}
                        </span>
                    </div>
                    <div style="font-size:12px;color:#666;">${msg.email || ''}</div>
                    <div style="font-size:13px;margin-top:5px;color:#333;">${msg.subject || 'Pas de sujet'}</div>
                </div>
            `;
        });
        
        const recentMessagesEl = document.getElementById('recentMessages');
        if (recentMessagesEl) {
            recentMessagesEl.innerHTML = html || '<p>Aucun message r√©cent</p>';
        }
    } catch(err) {
        const recentMessagesEl = document.getElementById('recentMessages');
        if (recentMessagesEl) {
            recentMessagesEl.innerHTML = '<p style="color:red;">Erreur de chargement</p>';
        }
    }
}

function updateOrderStats() {
    const pendingOrders = allOrders.filter(o => o.status === 'pending').length;
    const completedOrders = allOrders.filter(o => o.status === 'delivered').length;
    addDebugInfo(`Commandes: ${allOrders.length} total, ${pendingOrders} en attente, ${completedOrders} livr√©es`);
}

function updateMessageStats() {
    const unreadMessages = allMessages.filter(m => m.status !== 'read').length;
    const repliedMessages = allMessages.filter(m => m.replied).length;
    addDebugInfo(`Messages: ${allMessages.length} total, ${unreadMessages} non lus, ${repliedMessages} r√©pondu`);
}

// ========== PROFILE FUNCTIONS ==========
async function changePassword() {
    const currentPassword = document.getElementById('currentPassword')?.value;
    const newPassword = document.getElementById('newPassword')?.value;
    const confirmPassword = document.getElementById('confirmNewPassword')?.value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('Veuillez remplir tous les champs', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('Les mots de passe ne correspondent pas', 'error');
        return;
    }
    
    if (newPassword.length < 6) {
        showNotification('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
        return;
    }
    
    try {
        const user = auth.currentUser;
        if (!user) {
            showNotification('Utilisateur non connect√©', 'error');
            return;
        }
        
        const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);
        
        // Re-authenticate user
        await user.reauthenticateWithCredential(credential);
        
        // Update password
        await user.updatePassword(newPassword);
        
        showNotification('Mot de passe chang√© avec succ√®s!', 'success');
        
        // Clear form
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
        
    } catch(err) {
        let errorMessage = 'Erreur: ' + err.message;
        if (err.code === 'auth/wrong-password') {
            errorMessage = 'Mot de passe actuel incorrect';
        } else if (err.code === 'auth/requires-recent-login') {
            errorMessage = 'Veuillez vous reconnecter avant de changer le mot de passe';
        }
        showNotification(errorMessage, 'error');
    }
}

// ========== UTILITY FUNCTIONS ==========
function formatDate(date) {
    if (!date) return 'Date inconnue';
    try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return 'Date invalide';
        return d.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch(e) {
        return 'Date inconnue';
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'En attente',
        'confirmed': 'Confirm√©e',
        'shipped': 'Exp√©di√©e',
        'delivered': 'Livr√©e',
        'cancelled': 'Annul√©e'
    };
    return statusMap[status] || status || 'Inconnu';
}

function addDebugInfo(message) {
    const debug = document.getElementById('debug');
    if (!debug) return;
    
    const timestamp = new Date().toLocaleTimeString();
    debug.innerHTML = `[${timestamp}] ${message}\n${debug.innerHTML}`;
    
    // Keep debug log manageable
    const lines = debug.innerHTML.split('\n');
    if (lines.length > 50) {
        debug.innerHTML = lines.slice(0, 50).join('\n');
    }
}

function showNotification(message, type = 'info') {
    // Remove any existing notifications first
    document.querySelectorAll('.notification').forEach(notif => notif.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

function openTab(tabName, event = null) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.classList.remove('active');
    });
    
    // Show the selected tab content
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Add active class to the clicked button
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        // Find and activate the corresponding button
        const correspondingButton = Array.from(tabButtons).find(btn => 
            btn.getAttribute('onclick')?.includes(tabName)
        );
        if (correspondingButton) {
            correspondingButton.classList.add('active');
        }
    }
    
    // Load data for the tab if needed
    switch(tabName) {
        case 'products':
            loadProductsFromFirebase();
            break;
        case 'orders':
            loadOrders();
            break;
        case 'contactMessages':
            loadContactMessages();
            break;
        case 'dashboard':
            loadDashboard();
            break;
    }
}

function viewOrderDetails(orderId) {
    const order = allOrders.find(o => o.id === orderId);
    if (!order) {
        showNotification('Commande non trouv√©e', 'error');
        return;
    }
    
    let itemsText = 'Aucun article';
    if (order.items && order.items.length > 0) {
        itemsText = order.items.map(item => {
            if (typeof item === 'object') {
                return `${item.name || item.productName || 'Produit'} (${item.size || 'Standard'}) - ${item.price || 0} MAD`;
            }
            return item;
        }).join('\n');
    }
    
    alert(`D√©tails de la commande #${orderId.substring(0, 8)}\n
Client: ${order.fullName || 'Non sp√©cifi√©'}
Email: ${order.email || 'Non sp√©cifi√©'}
T√©l√©phone: ${order.phone || 'Non sp√©cifi√©'}
Adresse: ${order.address || ''}, ${order.city || ''} ${order.postalCode || ''}

Articles:
${itemsText}

Total: ${order.totalAmount || 0} MAD
Statut: ${getStatusText(order.status)}
Date: ${formatDate(order.createdAt)}`);
}

// ========== AUTH FUNCTIONS ==========
function showRegister() {
    const authForm = document.querySelector('.auth-form');
    const registerForm = document.getElementById('registerForm');
    if (authForm && registerForm) {
        authForm.style.display = 'none';
        registerForm.classList.remove('hidden');
    }
}

function showLogin() {
    const authForm = document.querySelector('.auth-form');
    const registerForm = document.getElementById('registerForm');
    const authMessage = document.getElementById('authMessage');
    
    if (authForm) authForm.style.display = 'block';
    if (registerForm) registerForm.classList.add('hidden');
    if (authMessage) authMessage.classList.add('hidden');
}

async function register() {
    const email = document.getElementById('regEmail')?.value;
    const password = document.getElementById('regPassword')?.value;
    const confirmPassword = document.getElementById('regConfirmPassword')?.value;
    
    if (!email || !password) {
        showAuthMessage('Veuillez remplir tous les champs', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showAuthMessage('Les mots de passe ne correspondent pas', 'error');
        return;
    }
    
    if (password.length < 6) {
        showAuthMessage('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
        return;
    }
    
    try {
        showAuthMessage('Cr√©ation du compte en cours...', 'info');
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        
        // Create admin profile in Firestore
        try {
            await db.collection('admins').doc(userCredential.user.uid).set({
                email: email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                role: 'admin'
            });
        } catch (firestoreErr) {
            console.warn('Could not create admin profile:', firestoreErr);
            // Continue anyway - the user is created in auth
        }
        
        showAuthMessage('Compte cr√©√© avec succ√®s! Vous √™tes maintenant connect√©.', 'success');
        
        // Don't call showAdminPanel here - auth state change will handle it
        
    } catch(err) {
        let errorMessage = 'Erreur lors de la cr√©ation du compte';
        switch(err.code) {
            case 'auth/email-already-in-use':
                errorMessage = 'Cet email est d√©j√† utilis√©';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Email invalide';
                break;
            case 'auth/weak-password':
                errorMessage = 'Mot de passe trop faible';
                break;
            default:
                errorMessage = err.message;
        }
        showAuthMessage(errorMessage, 'error');
    }
}

async function login() {
    const email = document.getElementById('email')?.value;
    const password = document.getElementById('password')?.value;
    
    if (!email || !password) {
        showAuthMessage('Veuillez entrer email et mot de passe', 'error');
        return;
    }
    
    try {
        showAuthMessage('Connexion en cours...', 'info');
        await auth.signInWithEmailAndPassword(email, password);
        showAuthMessage('Connexion r√©ussie!', 'success');
        // Don't call showAdminPanel here - auth state change will handle it
        
    } catch(err) {
        let errorMessage = 'Erreur de connexion';
        switch(err.code) {
            case 'auth/user-not-found':
                errorMessage = 'Utilisateur non trouv√©';
                break;
            case 'auth/wrong-password':
                errorMessage = 'Mot de passe incorrect';
                break;
            case 'auth/invalid-email':
                errorMessage = 'Email invalide';
                break;
            case 'auth/user-disabled':
                errorMessage = 'Compte d√©sactiv√©';
                break;
            default:
                errorMessage = err.message;
        }
        showAuthMessage(errorMessage, 'error');
    }
}

function showAuthMessage(message, type) {
    const authMessage = document.getElementById('authMessage');
    if (!authMessage) return;
    
    authMessage.textContent = message;
    authMessage.className = `alert alert-${type}`;
    authMessage.classList.remove('hidden');
}

function logout() {
    if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter?')) {
        auth.signOut();
        // Don't call showLoginPanel here - auth state change will handle it
    }
}

function showAdminPanel() {
    const authSection = document.getElementById('authSection');
    const adminPanel = document.getElementById('adminPanel');
    
    if (authSection) authSection.style.display = 'none';
    if (adminPanel) adminPanel.classList.remove('hidden');
    
    // Update user email
    const user = auth.currentUser;
    const userEmailEl = document.getElementById('userEmail');
    if (user && userEmailEl) {
        userEmailEl.textContent = user.email;
    }
    
    // Set dashboard as active tab
    setTimeout(() => {
        openTab('dashboard');
    }, 100);
    
    // Load initial data
    loadDashboard();
    loadProductsFromFirebase();
    loadOrders();
    loadContactMessages();
}

function showLoginPanel() {
    const authSection = document.getElementById('authSection');
    const adminPanel = document.getElementById('adminPanel');
    const authMessage = document.getElementById('authMessage');
    
    if (authSection) authSection.style.display = 'block';
    if (adminPanel) adminPanel.classList.add('hidden');
    if (authMessage) authMessage.classList.add('hidden');
    
    const authForm = document.querySelector('.auth-form');
    const registerForm = document.getElementById('registerForm');
    
    if (authForm) authForm.style.display = 'block';
    if (registerForm) registerForm.classList.add('hidden');
    
    // Clear form fields
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    
    if (emailInput) emailInput.value = '';
    if (passwordInput) passwordInput.value = '';
}

// ========== ADDITIONAL UTILITY FUNCTIONS ==========
function showUploadStatus(message, type) {
    const uploadStatus = document.getElementById('uploadStatus');
    if (!uploadStatus) return;
    
    uploadStatus.textContent = message;
    uploadStatus.className = 'upload-status';
    uploadStatus.classList.add(`upload-${type}`);
    uploadStatus.style.display = 'block';
    
    // Auto-hide success messages after 3 seconds
    if (type === 'success') {
        setTimeout(() => {
            uploadStatus.style.display = 'none';
        }, 3000);
    }
}

function getStatusColor(status) {
    const colors = {
        'pending': '#ff9800',
        'confirmed': '#2196f3',
        'shipped': '#9c27b0',
        'delivered': '#4caf50',
        'cancelled': '#f44336'
    };
    return colors[status] || '#9e9e9e';
}

// ========== INITIALIZATION ==========
// Check auth state
auth.onAuthStateChanged((user) => {
    addDebugInfo('Auth state changed: ' + (user ? 'User logged in' : 'User logged out'));
    if (user) {
        // User is signed in
        showAdminPanel();
    } else {
        // User is signed out
        showLoginPanel();
    }
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    addDebugInfo('Admin panel initialis√©');
    
    // Set default "en stock" checkbox as checked
    const defaultStockCheckbox = document.getElementById('stock-in');
    if (defaultStockCheckbox) defaultStockCheckbox.checked = true;
    
    // Initialize the first tab
    const initialTab = document.querySelector('.tab-button.active');
    if (initialTab) {
        const tabName = initialTab.getAttribute('onclick')?.match(/openTab\('([^']+)'\)/)?.[1];
        if (tabName) {
            openTab(tabName);
        }
    }
});

// Global error handler
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    addDebugInfo('Erreur globale: ' + e.message);
});

</script>
</body>
</html>
